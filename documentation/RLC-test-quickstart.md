# Table of contents

- [Table of contents](#table-of-contents)
- [Overview](#overview)
- [Prerequisites](#prerequisites)
- [How to Run Test](#how-to-run-test)
  - [Test strucure](#test-strucure)
  - [Fail to run tests in the first time](#fail-to-run-tests-in-the-first-time)
  - [Setup your development environment](#setup-your-development-environment)
  - [Prepare credentials](#prepare-credentials)
  - [Running tests in record mode](#running-tests-in-record-mode)
  - [Running tests in live mode](#running-tests-in-live-mode)
  - [Running tests in playback mode](#running-tests-in-playback-mode)
- [Writing New Tests](#writing-new-tests)

# Overview

This page is to help you write and run tests for Azure Javascript SDK. The Azure SDK test framework uses the [`test-recorder`](https://github.com/Azure/azure-sdk-for-js/blob/main/sdk/test-utils/recorder/README.md) library, which in turn rests upon on a HTTP recording system ([testproxy](https://github.com/Azure/azure-sdk-tools/tree/main/tools/test-proxy)) that enables tests dependent on network interaction to be run offline.

# Prerequisites

- Docker
  - [Docker](https://www.docker.com/get-started/) is required, as the [test proxy server](https://github.com/Azure/azure-sdk-tools/tree/main/tools/test-proxy) is running in a container during testing
  - When running the tests, ensure the Docker daemon is running and you have permission to use it.
- Rush 5.x
  - Install/update Rush globally via `npm install -g @microsoft/rush`
- Any of [the LTS versions of Node.js](https://nodejs.org/en/about/releases/)
- A C++ compiler toolchain and Python (for compiling machine-code modules)
  - Refer [here](https://github.com/Azure/azure-sdk-for-js/blob/main/CONTRIBUTING.md#prerequisites) for more details

# How to Run Test

This section describes how to run the SDK tests. If you want to run the tests of a specific project, go to that project's folder and execute `rushx test`. All of the tests will automatically run both in NodeJS and in the browser. To target these environments individually, you can run `rushx test:node` and `rushx test:browser`. Let's take `purview-catalog-rest` as an example.

## Test strucure

If you are the first time to generate SDK you could enable the config `generate-test: true` in `README.md`. We'll generate simple utils and a sample test file for you with below similar structure. They only contains basics for testing, so you need to update to your own utility and test cases.

```
sdk/
├─ purview/
│  ├─ purview-catalog-rest/
│  │  ├─ src/
│  │  │  ├─ ...
│  │  ├─ test/
│  │  │  ├─ public/
│  │  │  |  ├─ utils/
│  │  │  |  |  ├─ env.ts
│  │  │  |  |  ├─ recordedClient.ts
│  │  │  ├─ sampleTest.spec.ts
```

## Fail to run tests in the first time

Here we could run the tests in `purview-catalog-rest`. By default, these npm scripts run previously recorded tests. The recordings have been generated by using a custom recording library called [`test-recorder`](https://github.com/Azure/azure-sdk-for-js/blob/main/sdk/test-utils/recorder/README.md).

```Shell
sdk/purview/purview-catalog-rest> rushx test
```

If you are the first time to run tests you may fail with below message because there is no any recordings found.

```
[node-tests]   My test
[node-tests]     1) "before each" hook for "sample test"
[node-tests]     2) "after each" hook for "sample test"
[node-tests]
[node-tests]
[node-tests]   0 passing (225ms)
[node-tests]   2 failing
[node-tests]
[node-tests]   1) My test
[node-tests]        "before each" hook for "sample test":
[node-tests]      RecorderError: Start request failed.
```

To record or update your recordings you need to set the environment variable `TEST_MODE` to `record`. On Linux, you could use `export` to set env variable:

```shell
export TEST_MODE=record && rushx test
```

On Windows, you could use `set`:

```shell
SET TEST_MODE=record&& rushx test
```

Then we could have following similar logs:

```
[test-info] ===TEST_MODE="record"===
[0] [test-proxy] Attempting to start test proxy at http://localhost:5000 & https://localhost:5001.
[0]
[0] [test-proxy] Image tag obtained from the powershell script => 1.0.0-dev.20220427.1
[0]
[0] [test-proxy] Check the output file "test-proxy-output.log" for test-proxy logs.
[node-tests] [check-with-timeout] waiting for 1000ms
[node-tests] [check-with-timeout] waiting for 1000ms
[node-tests] [test-proxy] Proxy tool seems to be active at http://localhost:5000
[node-tests]
[node-tests] [check-with-timeout] checkWithTimeout condition returned true
[node-tests]
[node-tests]
[node-tests]   My test
[node-tests]     √ sample test
[node-tests]
[node-tests]
[node-tests]   1 passing (223ms)
```

## Setup your development environment

## Prepare credentials

## Running tests in record mode

## Running tests in live mode

## Running tests in playback mode

# Writing New Tests

Test structure
Writing test

Example 1: Basic Azure service interaction and recording
Example 2: Basic preparer usage
