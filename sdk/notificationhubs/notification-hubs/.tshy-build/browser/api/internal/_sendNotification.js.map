{"version":3,"file":"_sendNotification.js","sourceRoot":"","sources":["../../../../src/api/internal/_sendNotification.ts"],"names":[],"mappings":"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","sourcesContent":["// Copyright (c) Microsoft Corporation.\n// Licensed under the MIT License.\n\nimport type {\n  BroadcastSendNotificationOptions,\n  DirectSendNotificationOptions,\n  SendNotificationOptions,\n} from \"../../models/options.js\";\nimport { createRequest, parseNotificationSendResponse, sendRequest } from \"./_client.js\";\nimport {\n  isBroadcastSendNotificationOptions,\n  isDirectSendNotificationOptions,\n  isSendNotificationOptions,\n} from \"../../utils/optionUtils.js\";\nimport type { BrowserPushChannel } from \"../../models/installation.js\";\nimport type { NonNullableRecord } from \"../../utils/utils.js\";\nimport type { Notification } from \"../../models/notification.js\";\nimport type { NotificationHubsClientContext } from \"../index.js\";\nimport type { NotificationHubsMessageResponse } from \"../../models/notificationDetails.js\";\nimport { createMultipartDirectNotification } from \"../../utils/notificationUtils.js\";\nimport { randomUUID } from \"@azure/core-util\";\nimport { tracingClient } from \"../../utils/tracing.js\";\n\n/**\n * Sends push notifications to devices that match the given tags or tag expression.\n * @param context - The Notification Hubs client.\n * @param notification - The notification to send to the matching devices.\n * @param options - Options for the notification including tags, device handles and whether to enable test send.\n * @returns A NotificationHubResponse with the tracking ID, correlation ID and location.\n */\nexport function sendNotificationInternal(\n  context: NotificationHubsClientContext,\n  notification: Notification,\n  options:\n    | DirectSendNotificationOptions\n    | SendNotificationOptions\n    | BroadcastSendNotificationOptions,\n): Promise<NotificationHubsMessageResponse> {\n  return tracingClient.withSpan(\n    `NotificationHubsClientContext.sendNotification`,\n    options,\n    async (updatedOptions) => {\n      const endpoint = context.requestUrl();\n      endpoint.pathname += \"/messages/\";\n\n      // Check if batch direct send\n      if (isDirectSendNotificationOptions(options) && Array.isArray(options.deviceHandle)) {\n        endpoint.pathname += \"$batch\";\n      }\n\n      // Check for test send\n      if (\n        (isSendNotificationOptions(options) || isBroadcastSendNotificationOptions(options)) &&\n        options.enableTestSend\n      ) {\n        endpoint.searchParams.append(\"test\", \"true\");\n      }\n\n      const headers = await context.createHeaders(\n        \"sendNotification\",\n        notification.headers as NonNullableRecord,\n      );\n      headers.set(\"ServiceBusNotification-Format\", notification.platform);\n\n      let body = notification.body;\n      let contentType: string = notification.contentType;\n\n      // Check for direct batch send\n      if (isDirectSendNotificationOptions(options) && Array.isArray(options.deviceHandle)) {\n        endpoint.searchParams.append(\"direct\", \"true\");\n        const boundary = `nh-boundary-${randomUUID()}`;\n        contentType = `multipart/mixed; boundary = \"${boundary}\"`;\n        body = createMultipartDirectNotification(boundary, notification, options.deviceHandle);\n      } else if (isDirectSendNotificationOptions(options)) {\n        endpoint.searchParams.append(\"direct\", \"true\");\n\n        if (notification.platform === \"browser\") {\n          const browserHandle = options.deviceHandle as BrowserPushChannel;\n          headers.set(\"ServiceBusNotification-DeviceHandle\", browserHandle.endpoint);\n          headers.set(\"Auth\", browserHandle.auth);\n          headers.set(\"P256DH\", browserHandle.p256dh);\n        } else {\n          headers.set(\"ServiceBusNotification-DeviceHandle\", options.deviceHandle as string);\n        }\n      } else if (isSendNotificationOptions(options)) {\n        headers.set(\"ServiceBusNotification-Tags\", options.tagExpression);\n      }\n\n      headers.set(\"Content-Type\", contentType);\n      headers.set(\"ServiceBusNotification-Format\", notification.platform);\n\n      const request = createRequest(endpoint, \"POST\", headers, updatedOptions);\n      request.body = body;\n\n      const response = await sendRequest(context, request, 201);\n\n      return parseNotificationSendResponse(response);\n    },\n  );\n}\n"]}