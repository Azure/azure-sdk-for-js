{"version":3,"file":"entraIdAccessToken.js","sourceRoot":"","sources":["../../../src/common/entraIdAccessToken.ts"],"names":[],"mappings":"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","sourcesContent":["// Copyright (c) Microsoft Corporation.\n// Licensed under the MIT License.\n\nimport type { TokenCredential } from \"@azure/identity\";\nimport { DefaultAzureCredential } from \"@azure/identity\";\nimport { coreLogger } from \"./logger.js\";\nimport {\n  EntraIdAccessTokenConstants,\n  InternalEnvironmentVariables,\n  ServiceEnvironmentVariable,\n} from \"./constants.js\";\nimport type { AccessTokenClaims } from \"./types.js\";\nimport { parseJwt } from \"../utils/parseJwt.js\";\nimport { ServiceErrorMessageConstants } from \"./messages.js\";\n\nexport class EntraIdAccessToken {\n  public token?: string;\n  private _expiryTimestamp?: number; // in milliseconds\n  private _credential?: TokenCredential;\n\n  constructor(credential?: TokenCredential) {\n    this._credential = credential ?? new DefaultAzureCredential();\n    this.setEntraIdAccessTokenFromEnvironment();\n  }\n\n  public fetchEntraIdAccessToken = async (): Promise<void> => {\n    try {\n      coreLogger.info(\"Fetching entra id access token\");\n      const accessToken = await this._credential!.getToken(EntraIdAccessTokenConstants.SCOPE);\n      if (!accessToken) {\n        throw new Error(\"Entra id access token is null\");\n      }\n      if (accessToken.token === this.token) {\n        // azure identity library can fetch the same token again from cache. 10 mins before expiry, it allows token refresh\n        coreLogger.info(\"Cached access token is returned, will be retried again.\");\n        return;\n      }\n      this.token = accessToken.token;\n      this._expiryTimestamp = accessToken.expiresOnTimestamp;\n      process.env[ServiceEnvironmentVariable.PLAYWRIGHT_SERVICE_ACCESS_TOKEN] = this.token!;\n      coreLogger.info(\"Entra id access token fetched and set in environment variable\");\n      coreLogger.info(\n        \"Entra id access token expiry:\",\n        new Date(this._expiryTimestamp).toISOString(),\n      );\n      return;\n    } catch (err) {\n      coreLogger.error(err);\n      process.env[InternalEnvironmentVariables.MPT_SETUP_FATAL_ERROR] = \"true\";\n      throw new Error(ServiceErrorMessageConstants.NO_AUTH_ERROR.message);\n    }\n  };\n\n  public doesEntraIdAccessTokenNeedRotation(): boolean {\n    if (!this.token) {\n      coreLogger.info(\"Entra id access token not found, needs rotation\");\n      return true;\n    }\n    const lifetimeLeft = this._expiryTimestamp! - new Date().getTime();\n    const doesEntraTokenRequireRotation =\n      lifetimeLeft <\n      EntraIdAccessTokenConstants.LIFETIME_LEFT_THRESHOLD_IN_MINUTES_FOR_ROTATION * 60 * 1000;\n    coreLogger.info(\n      \"Entra id access token requires rotation:\",\n      doesEntraTokenRequireRotation ? \"Yes\" : \"No\",\n    );\n    return doesEntraTokenRequireRotation;\n  }\n\n  private setEntraIdAccessTokenFromEnvironment = (): void => {\n    try {\n      const token = process.env[ServiceEnvironmentVariable.PLAYWRIGHT_SERVICE_ACCESS_TOKEN];\n      if (!token) {\n        return;\n      }\n      const claims = parseJwt<Partial<AccessTokenClaims>>(token);\n      if (claims.accountId || claims.aid) {\n        return;\n      } // mpt PAT\n      const expiry = new Date(claims.exp! * 1000);\n      this.token = token;\n      this._expiryTimestamp = expiry.getTime();\n    } catch (_) {\n      return;\n    }\n  };\n}\n\nexport function createEntraIdAccessToken(credential?: TokenCredential): EntraIdAccessToken {\n  return new EntraIdAccessToken(credential);\n}\n"]}