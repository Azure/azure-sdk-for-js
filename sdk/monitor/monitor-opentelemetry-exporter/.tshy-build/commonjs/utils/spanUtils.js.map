{"version":3,"file":"spanUtils.js","sourceRoot":"","sources":["../../../src/utils/spanUtils.ts"],"names":[],"mappings":"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","sourcesContent":["// Copyright (c) Microsoft Corporation.\n// Licensed under the MIT License.\n\nimport type { ReadableSpan, TimedEvent } from \"@opentelemetry/sdk-trace-base\";\nimport { hrTimeToMilliseconds } from \"@opentelemetry/core\";\nimport type { Link, Attributes, AttributeValue } from \"@opentelemetry/api\";\nimport { diag, SpanKind, SpanStatusCode } from \"@opentelemetry/api\";\nimport {\n  DBSYSTEMVALUES_MONGODB,\n  DBSYSTEMVALUES_MYSQL,\n  DBSYSTEMVALUES_POSTGRESQL,\n  DBSYSTEMVALUES_REDIS,\n  SEMATTRS_DB_NAME,\n  SEMATTRS_DB_OPERATION,\n  SEMATTRS_DB_STATEMENT,\n  SEMATTRS_DB_SYSTEM,\n  SEMATTRS_ENDUSER_ID,\n  SEMATTRS_EXCEPTION_ESCAPED,\n  SEMATTRS_EXCEPTION_MESSAGE,\n  SEMATTRS_EXCEPTION_STACKTRACE,\n  SEMATTRS_EXCEPTION_TYPE,\n  SEMATTRS_HTTP_CLIENT_IP,\n  SEMATTRS_HTTP_METHOD,\n  SEMATTRS_HTTP_STATUS_CODE,\n  SEMATTRS_HTTP_URL,\n  SEMATTRS_HTTP_USER_AGENT,\n  SEMATTRS_NET_PEER_IP,\n  SEMATTRS_RPC_GRPC_STATUS_CODE,\n  SEMATTRS_RPC_SYSTEM,\n  ATTR_HTTP_REQUEST_METHOD,\n  ATTR_CLIENT_ADDRESS,\n  ATTR_NETWORK_PEER_ADDRESS,\n  ATTR_USER_AGENT_ORIGINAL,\n  ATTR_HTTP_ROUTE,\n  ATTR_URL_FULL,\n  ATTR_HTTP_RESPONSE_STATUS_CODE,\n  SEMATTRS_HTTP_SCHEME,\n  ATTR_URL_SCHEME,\n  SEMATTRS_HTTP_TARGET,\n  ATTR_URL_PATH,\n  ATTR_URL_QUERY,\n  ATTR_SERVER_ADDRESS,\n  SEMATTRS_HTTP_HOST,\n  SEMATTRS_NET_PEER_NAME,\n  ATTR_CLIENT_PORT,\n  ATTR_SERVER_PORT,\n  SEMATTRS_NET_PEER_PORT,\n} from \"@opentelemetry/semantic-conventions\";\n\nimport {\n  createTagsFromResource,\n  getDependencyTarget,\n  getUrl,\n  hrTimeToDate,\n  isSqlDB,\n  isSyntheticSource,\n  serializeAttribute,\n} from \"./common.js\";\nimport type { Tags, Properties, MSLink, Measurements } from \"../types.js\";\nimport {\n  httpSemanticValues,\n  internalMicrosoftAttributes,\n  legacySemanticValues,\n  MaxPropertyLengths,\n} from \"../types.js\";\nimport { parseEventHubSpan } from \"./eventhub.js\";\nimport {\n  AzureMonitorSampleRate,\n  DependencyTypes,\n  MS_LINKS,\n} from \"./constants/applicationinsights.js\";\nimport { AzNamespace, MicrosoftEventHub } from \"./constants/span/azAttributes.js\";\nimport type {\n  TelemetryExceptionData,\n  MessageData,\n  RemoteDependencyData,\n  RequestData,\n  TelemetryItem as Envelope,\n  TelemetryExceptionDetails,\n} from \"../generated/index.js\";\nimport { KnownContextTagKeys } from \"../generated/index.js\";\nimport { msToTimeSpan } from \"./breezeUtils.js\";\n\nfunction createTagsFromSpan(span: ReadableSpan): Tags {\n  const tags: Tags = createTagsFromResource(span.resource);\n  tags[KnownContextTagKeys.AiOperationId] = span.spanContext().traceId;\n  if (span.parentSpanId) {\n    tags[KnownContextTagKeys.AiOperationParentId] = span.parentSpanId;\n  }\n  const endUserId = span.attributes[SEMATTRS_ENDUSER_ID];\n  if (endUserId) {\n    tags[KnownContextTagKeys.AiUserId] = String(endUserId);\n  }\n  const httpUserAgent = getUserAgent(span.attributes);\n  if (httpUserAgent) {\n    // TODO: Not exposed in Swagger, need to update def\n    tags[\"ai.user.userAgent\"] = String(httpUserAgent);\n  }\n  if (isSyntheticSource(span.attributes)) {\n    tags[KnownContextTagKeys.AiOperationSyntheticSource] = \"True\";\n  }\n  if (span.kind === SpanKind.SERVER) {\n    const httpMethod = getHttpMethod(span.attributes);\n    getLocationIp(tags, span.attributes);\n    if (httpMethod) {\n      const httpRoute = span.attributes[ATTR_HTTP_ROUTE];\n      const httpUrl = getHttpUrl(span.attributes);\n      tags[KnownContextTagKeys.AiOperationName] = span.name; // Default\n      if (httpRoute) {\n        // AiOperationName max length is 1024\n        // https://github.com/MohanGsk/ApplicationInsights-Home/blob/master/EndpointSpecs/Schemas/Bond/ContextTagKeys.bond\n        tags[KnownContextTagKeys.AiOperationName] = String(\n          `${httpMethod as string} ${httpRoute as string}`,\n        ).substring(0, MaxPropertyLengths.TEN_BIT);\n      } else if (httpUrl) {\n        try {\n          const url = new URL(String(httpUrl));\n          tags[KnownContextTagKeys.AiOperationName] = String(\n            `${httpMethod} ${url.pathname}`,\n          ).substring(0, MaxPropertyLengths.TEN_BIT);\n        } catch {\n          /* no-op */\n        }\n      }\n    } else {\n      tags[KnownContextTagKeys.AiOperationName] = span.name;\n    }\n  } else {\n    if (span.attributes[KnownContextTagKeys.AiOperationName]) {\n      tags[KnownContextTagKeys.AiOperationName] = span.attributes[\n        KnownContextTagKeys.AiOperationName\n      ] as string;\n    }\n  }\n  // TODO: Location IP TBD for non server spans\n\n  return tags;\n}\n\nfunction createPropertiesFromSpanAttributes(attributes?: Attributes): {\n  [propertyName: string]: string;\n} {\n  const properties: { [propertyName: string]: string } = {};\n  if (attributes) {\n    for (const key of Object.keys(attributes)) {\n      // Avoid duplication ignoring fields already mapped.\n      if (\n        // We need to not ignore the _MS.ProcessedByMetricExtractors key as it's used to identify standard metrics\n        !(\n          (key.startsWith(\"_MS.\") && !internalMicrosoftAttributes.includes(key as any)) ||\n          key.startsWith(\"microsoft.\") ||\n          legacySemanticValues.includes(key) ||\n          httpSemanticValues.includes(key as any) ||\n          key === (KnownContextTagKeys.AiOperationName as string)\n        )\n      ) {\n        properties[key] = serializeAttribute(attributes[key]);\n      }\n    }\n  }\n  return properties;\n}\n\nfunction createPropertiesFromSpan(span: ReadableSpan): [Properties, Measurements] {\n  const properties: Properties = createPropertiesFromSpanAttributes(span.attributes);\n  const measurements: Measurements = {};\n\n  const links: MSLink[] = span.links.map((link: Link) => ({\n    operation_Id: link.context.traceId,\n    id: link.context.spanId,\n  }));\n  if (links.length > 0) {\n    properties[MS_LINKS] = JSON.stringify(links);\n  }\n  return [properties, measurements];\n}\n\nfunction createDependencyData(span: ReadableSpan): RemoteDependencyData {\n  const remoteDependencyData: RemoteDependencyData = {\n    name: span.name, // Default\n    id: `${span.spanContext().spanId}`,\n    success: span.status?.code !== SpanStatusCode.ERROR,\n    resultCode: \"0\",\n    type: \"Dependency\",\n    duration: msToTimeSpan(hrTimeToMilliseconds(span.duration)),\n    version: 2,\n  };\n  if (span.kind === SpanKind.PRODUCER) {\n    remoteDependencyData.type = DependencyTypes.QueueMessage;\n  }\n  if (span.kind === SpanKind.INTERNAL && span.parentSpanId) {\n    remoteDependencyData.type = DependencyTypes.InProc;\n  }\n\n  const httpMethod = getHttpMethod(span.attributes);\n  const dbSystem = span.attributes[SEMATTRS_DB_SYSTEM];\n  const rpcSystem = span.attributes[SEMATTRS_RPC_SYSTEM];\n  // HTTP Dependency\n  if (httpMethod) {\n    const httpUrl = getHttpUrl(span.attributes);\n    if (httpUrl) {\n      try {\n        const dependencyUrl = new URL(String(httpUrl));\n        remoteDependencyData.name = `${httpMethod} ${dependencyUrl.pathname}`;\n      } catch {\n        /* no-op */\n      }\n    }\n    remoteDependencyData.type = DependencyTypes.Http;\n    remoteDependencyData.data = getUrl(span.attributes);\n    const httpStatusCode = getHttpStatusCode(span.attributes);\n    if (httpStatusCode) {\n      remoteDependencyData.resultCode = String(httpStatusCode);\n    }\n    let target = getDependencyTarget(span.attributes);\n    if (target) {\n      try {\n        // Remove default port\n        const portRegex = new RegExp(/(https?)(:\\/\\/.*)(:\\d+)(\\S*)/);\n        const res = portRegex.exec(target);\n        if (res !== null) {\n          const protocol = res[1];\n          const port = res[3];\n          if (\n            (protocol === \"https\" && port === \":443\") ||\n            (protocol === \"http\" && port === \":80\")\n          ) {\n            // Drop port\n            target = res[1] + res[2] + res[4];\n          }\n        }\n      } catch {\n        /* no-op */\n      }\n      remoteDependencyData.target = `${target}`;\n    }\n  }\n  // DB Dependency\n  else if (dbSystem) {\n    // TODO: Remove special logic when Azure UX supports OpenTelemetry dbSystem\n    if (String(dbSystem) === DBSYSTEMVALUES_MYSQL) {\n      remoteDependencyData.type = \"mysql\";\n    } else if (String(dbSystem) === DBSYSTEMVALUES_POSTGRESQL) {\n      remoteDependencyData.type = \"postgresql\";\n    } else if (String(dbSystem) === DBSYSTEMVALUES_MONGODB) {\n      remoteDependencyData.type = \"mongodb\";\n    } else if (String(dbSystem) === DBSYSTEMVALUES_REDIS) {\n      remoteDependencyData.type = \"redis\";\n    } else if (isSqlDB(String(dbSystem))) {\n      remoteDependencyData.type = \"SQL\";\n    } else {\n      remoteDependencyData.type = String(dbSystem);\n    }\n    const dbStatement = span.attributes[SEMATTRS_DB_STATEMENT];\n    const dbOperation = span.attributes[SEMATTRS_DB_OPERATION];\n    if (dbStatement) {\n      remoteDependencyData.data = String(dbStatement);\n    } else if (dbOperation) {\n      remoteDependencyData.data = String(dbOperation);\n    }\n    const target = getDependencyTarget(span.attributes);\n    const dbName = span.attributes[SEMATTRS_DB_NAME];\n    if (target) {\n      remoteDependencyData.target = dbName ? `${target}|${dbName}` : `${target}`;\n    } else {\n      remoteDependencyData.target = dbName ? `${dbName}` : `${dbSystem}`;\n    }\n  }\n  // grpc Dependency\n  else if (rpcSystem) {\n    if (rpcSystem === DependencyTypes.Wcf) {\n      remoteDependencyData.type = DependencyTypes.Wcf;\n    } else {\n      remoteDependencyData.type = DependencyTypes.Grpc;\n    }\n    const grpcStatusCode = span.attributes[SEMATTRS_RPC_GRPC_STATUS_CODE];\n    if (grpcStatusCode) {\n      remoteDependencyData.resultCode = String(grpcStatusCode);\n    }\n    const target = getDependencyTarget(span.attributes);\n    if (target) {\n      remoteDependencyData.target = `${target}`;\n    } else if (rpcSystem) {\n      remoteDependencyData.target = String(rpcSystem);\n    }\n  }\n  return remoteDependencyData;\n}\n\nfunction createRequestData(span: ReadableSpan): RequestData {\n  const requestData: RequestData = {\n    id: `${span.spanContext().spanId}`,\n    success:\n      span.status.code !== SpanStatusCode.ERROR &&\n      (Number(getHttpStatusCode(span.attributes)) || 0) < 400,\n    responseCode: \"0\",\n    duration: msToTimeSpan(hrTimeToMilliseconds(span.duration)),\n    version: 2,\n    source: undefined,\n  };\n  const httpMethod = getHttpMethod(span.attributes);\n  const grpcStatusCode = span.attributes[SEMATTRS_RPC_GRPC_STATUS_CODE];\n  if (httpMethod) {\n    requestData.url = getUrl(span.attributes);\n    const httpStatusCode = getHttpStatusCode(span.attributes);\n    if (httpStatusCode) {\n      requestData.responseCode = String(httpStatusCode);\n    }\n  } else if (grpcStatusCode) {\n    requestData.responseCode = String(grpcStatusCode);\n  }\n  return requestData;\n}\n\n/**\n * Span to Azure envelope parsing.\n * @internal\n */\nexport function readableSpanToEnvelope(span: ReadableSpan, ikey: string): Envelope {\n  let name: string;\n  let baseType: \"RemoteDependencyData\" | \"RequestData\";\n  let baseData: RemoteDependencyData | RequestData;\n\n  const time = hrTimeToDate(span.startTime);\n  const instrumentationKey = ikey;\n  const tags = createTagsFromSpan(span);\n  const [properties, measurements] = createPropertiesFromSpan(span);\n  switch (span.kind) {\n    case SpanKind.CLIENT:\n    case SpanKind.PRODUCER:\n    case SpanKind.INTERNAL:\n      name = \"Microsoft.ApplicationInsights.RemoteDependency\";\n      baseType = \"RemoteDependencyData\";\n      baseData = createDependencyData(span);\n      break;\n    case SpanKind.SERVER:\n    case SpanKind.CONSUMER:\n      name = \"Microsoft.ApplicationInsights.Request\";\n      baseType = \"RequestData\";\n      baseData = createRequestData(span);\n      baseData.name = tags[KnownContextTagKeys.AiOperationName];\n      break;\n    default:\n      // never\n      diag.error(`Unsupported span kind ${span.kind}`);\n      throw new Error(`Unsupported span kind ${span.kind}`);\n  }\n\n  let sampleRate = 100;\n  if (span.attributes[AzureMonitorSampleRate]) {\n    sampleRate = Number(span.attributes[AzureMonitorSampleRate]);\n  }\n\n  // Azure SDK\n  if (span.attributes[AzNamespace]) {\n    if (span.kind === SpanKind.INTERNAL) {\n      baseData.type = `${DependencyTypes.InProc} | ${span.attributes[AzNamespace]}`;\n    }\n    if (span.attributes[AzNamespace] === MicrosoftEventHub) {\n      parseEventHubSpan(span, baseData);\n    }\n  }\n\n  // Truncate properties\n  if (baseData.id) {\n    baseData.id = baseData.id.substring(0, MaxPropertyLengths.NINE_BIT);\n  }\n  if (baseData.name) {\n    baseData.name = baseData.name.substring(0, MaxPropertyLengths.TEN_BIT);\n  }\n  if (baseData.resultCode) {\n    baseData.resultCode = String(baseData.resultCode).substring(0, MaxPropertyLengths.TEN_BIT);\n  }\n  if (baseData.data) {\n    baseData.data = String(baseData.data).substring(0, MaxPropertyLengths.THIRTEEN_BIT);\n  }\n  if (baseData.type) {\n    baseData.type = String(baseData.type).substring(0, MaxPropertyLengths.TEN_BIT);\n  }\n  if (baseData.target) {\n    baseData.target = String(baseData.target).substring(0, MaxPropertyLengths.TEN_BIT);\n  }\n  if (baseData.properties) {\n    for (const key of Object.keys(baseData.properties)) {\n      baseData.properties[key] = baseData.properties[key].substring(\n        0,\n        MaxPropertyLengths.THIRTEEN_BIT,\n      );\n    }\n  }\n\n  return {\n    name,\n    sampleRate,\n    time,\n    instrumentationKey,\n    tags,\n    version: 1,\n    data: {\n      baseType,\n      baseData: {\n        ...baseData,\n        properties,\n        measurements,\n      },\n    },\n  };\n}\n\n/**\n * Span Events to Azure envelopes parsing.\n * @internal\n */\nexport function spanEventsToEnvelopes(span: ReadableSpan, ikey: string): Envelope[] {\n  const envelopes: Envelope[] = [];\n  if (span.events) {\n    span.events.forEach((event: TimedEvent) => {\n      let baseType: \"ExceptionData\" | \"MessageData\";\n      const time = hrTimeToDate(event.time);\n      let name = \"\";\n      let baseData: TelemetryExceptionData | MessageData;\n      const properties = createPropertiesFromSpanAttributes(event.attributes);\n\n      const tags: Tags = createTagsFromResource(span.resource);\n      tags[KnownContextTagKeys.AiOperationId] = span.spanContext().traceId;\n      const spanId = span.spanContext()?.spanId;\n      if (spanId) {\n        tags[KnownContextTagKeys.AiOperationParentId] = spanId;\n      }\n\n      // Only generate exception telemetry for incoming requests\n      if (event.name === \"exception\") {\n        name = \"Microsoft.ApplicationInsights.Exception\";\n        baseType = \"ExceptionData\";\n        let typeName = \"\";\n        let message = \"Exception\";\n        let stack = \"\";\n        let hasFullStack = false;\n        if (event.attributes) {\n          typeName = String(event.attributes[SEMATTRS_EXCEPTION_TYPE]);\n          stack = String(event.attributes[SEMATTRS_EXCEPTION_STACKTRACE]);\n          if (stack) {\n            hasFullStack = true;\n          }\n          const exceptionMsg = event.attributes[SEMATTRS_EXCEPTION_MESSAGE];\n          if (exceptionMsg) {\n            message = String(exceptionMsg);\n          }\n          const escaped = event.attributes[SEMATTRS_EXCEPTION_ESCAPED];\n          if (escaped !== undefined) {\n            properties[SEMATTRS_EXCEPTION_ESCAPED] = String(escaped);\n          }\n        }\n        const exceptionDetails: TelemetryExceptionDetails = {\n          typeName: typeName,\n          message: message,\n          stack: stack,\n          hasFullStack: hasFullStack,\n        };\n        const exceptionData: TelemetryExceptionData = {\n          exceptions: [exceptionDetails],\n          version: 2,\n          properties: properties,\n        };\n        baseData = exceptionData;\n      } else {\n        name = \"Microsoft.ApplicationInsights.Message\";\n        baseType = \"MessageData\";\n        const messageData: MessageData = {\n          message: event.name,\n          version: 2,\n          properties: properties,\n        };\n        baseData = messageData;\n      }\n      let sampleRate = 100;\n      if (span.attributes[AzureMonitorSampleRate]) {\n        sampleRate = Number(span.attributes[AzureMonitorSampleRate]);\n      }\n      // Truncate properties\n      if (baseData.message) {\n        baseData.message = String(baseData.message).substring(0, MaxPropertyLengths.FIFTEEN_BIT);\n      }\n      if (baseData.properties) {\n        for (const key of Object.keys(baseData.properties)) {\n          baseData.properties[key] = baseData.properties[key].substring(\n            0,\n            MaxPropertyLengths.THIRTEEN_BIT,\n          );\n        }\n      }\n      const env: Envelope = {\n        name: name,\n        time: time,\n        instrumentationKey: ikey,\n        version: 1,\n        sampleRate: sampleRate,\n        data: {\n          baseType: baseType,\n          baseData: baseData,\n        },\n        tags: tags,\n      };\n      envelopes.push(env);\n    });\n  }\n  return envelopes;\n}\n\nexport function getPeerIp(attributes: Attributes): AttributeValue | undefined {\n  if (attributes) {\n    return attributes[ATTR_NETWORK_PEER_ADDRESS] || attributes[SEMATTRS_NET_PEER_IP];\n  }\n  return;\n}\n\nexport function getLocationIp(tags: Tags, attributes: Attributes): void {\n  if (attributes) {\n    const httpClientIp = getHttpClientIp(attributes);\n    const netPeerIp = getPeerIp(attributes);\n    if (httpClientIp) {\n      tags[KnownContextTagKeys.AiLocationIp] = String(httpClientIp);\n    } else if (netPeerIp) {\n      tags[KnownContextTagKeys.AiLocationIp] = String(netPeerIp);\n    }\n  }\n}\n\nexport function getHttpClientIp(attributes: Attributes): AttributeValue | undefined {\n  if (attributes) {\n    return attributes[ATTR_CLIENT_ADDRESS] || attributes[SEMATTRS_HTTP_CLIENT_IP];\n  }\n  return;\n}\n\nexport function getUserAgent(attributes: Attributes): AttributeValue | undefined {\n  if (attributes) {\n    return attributes[ATTR_USER_AGENT_ORIGINAL] || attributes[SEMATTRS_HTTP_USER_AGENT];\n  }\n  return;\n}\n\nexport function getHttpUrl(attributes: Attributes): AttributeValue | undefined {\n  // Stable sem conv only supports populating url from `url.full`\n  if (attributes) {\n    return attributes[ATTR_URL_FULL] || attributes[SEMATTRS_HTTP_URL];\n  }\n  return;\n}\n\nexport function getHttpMethod(attributes: Attributes): AttributeValue | undefined {\n  if (attributes) {\n    return attributes[ATTR_HTTP_REQUEST_METHOD] || attributes[SEMATTRS_HTTP_METHOD];\n  }\n  return;\n}\n\nexport function getHttpStatusCode(attributes: Attributes): AttributeValue | undefined {\n  if (attributes) {\n    return attributes[ATTR_HTTP_RESPONSE_STATUS_CODE] || attributes[SEMATTRS_HTTP_STATUS_CODE];\n  }\n  return;\n}\n\nexport function getHttpScheme(attributes: Attributes): AttributeValue | undefined {\n  if (attributes) {\n    return attributes[ATTR_URL_SCHEME] || attributes[SEMATTRS_HTTP_SCHEME];\n  }\n  return;\n}\n\nexport function getHttpTarget(attributes: Attributes): AttributeValue | undefined {\n  if (attributes) {\n    if (attributes[ATTR_URL_PATH]) {\n      return attributes[ATTR_URL_PATH];\n    }\n    if (attributes[ATTR_URL_QUERY]) {\n      return attributes[ATTR_URL_QUERY];\n    }\n    return attributes[SEMATTRS_HTTP_TARGET];\n  }\n  return;\n}\n\nexport function getHttpHost(attributes: Attributes): AttributeValue | undefined {\n  if (attributes) {\n    return attributes[ATTR_SERVER_ADDRESS] || attributes[SEMATTRS_HTTP_HOST];\n  }\n  return;\n}\n\nexport function getNetPeerName(attributes: Attributes): AttributeValue | undefined {\n  if (attributes) {\n    return attributes[ATTR_CLIENT_ADDRESS] || attributes[SEMATTRS_NET_PEER_NAME];\n  }\n  return;\n}\n\nexport function getNetPeerPort(attributes: Attributes): AttributeValue | undefined {\n  if (attributes) {\n    return (\n      attributes[ATTR_CLIENT_PORT] ||\n      attributes[ATTR_SERVER_PORT] ||\n      attributes[SEMATTRS_NET_PEER_PORT]\n    );\n  }\n  return;\n}\n"]}