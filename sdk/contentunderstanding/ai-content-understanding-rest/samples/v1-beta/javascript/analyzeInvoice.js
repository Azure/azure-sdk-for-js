// Copyright (c) Microsoft Corporation.
// Licensed under the MIT License.

/**
 * @summary Analyze an invoice from a URL using the prebuilt-invoice analyzer.
 *
 * This sample demonstrates how to analyze an invoice from a URL using the prebuilt-invoice
 * analyzer and extract structured fields from the result.
 *
 * Content Understanding provides 70+ production-ready prebuilt analyzers that are ready to use
 * without any training or configuration. The prebuilt-invoice analyzer automatically extracts:
 * - Customer/Vendor information: Name, address, contact details
 * - Invoice metadata: Invoice number, date, due date, purchase order number
 * - Line items: Description, quantity, unit price, total for each item
 * - Financial totals: Subtotal, tax amount, shipping charges, total amount
 * - Payment information: Payment terms, payment method, remittance address
 */

require("dotenv/config");
const { DefaultAzureCredential } = require("@azure/identity");
const { AzureKeyCredential } = require("@azure/core-auth");
const { ContentUnderstandingClient } = require("@azure-rest/ai-content-understanding");

function getCredential() {
  const key = process.env["AZURE_CONTENT_UNDERSTANDING_KEY"];
  if (key) {
    return new AzureKeyCredential(key);
  }
  return new DefaultAzureCredential();
}

async function main() {
  console.log("== Analyze Invoice Sample ==");

  const endpoint = process.env["AZURE_CONTENT_UNDERSTANDING_ENDPOINT"];
  if (!endpoint) {
    throw new Error("AZURE_CONTENT_UNDERSTANDING_ENDPOINT is required.");
  }

  const client = new ContentUnderstandingClient(endpoint, getCredential());

  const invoiceUrl =
    "https://github.com/Azure-Samples/azure-ai-content-understanding-python/raw/refs/heads/main/data/invoice.pdf";

  console.log("Analyzing invoice with prebuilt-invoice analyzer...");
  console.log(`  URL: ${invoiceUrl}`);

  const poller = client.analyze("prebuilt-invoice", {
    inputs: [{ url: invoiceUrl }],
  });
  const result = await poller.pollUntilDone();

  if (!result.contents || result.contents.length === 0) {
    console.log("No content found in the analysis result.");
    return;
  }

  const content = result.contents[0];

  // Get the document content (invoices are documents)
  if (content.kind === "document") {
    const documentContent = content;

    // Print document unit information
    console.log(`\nDocument unit: ${documentContent.unit ?? "unknown"}`);
    console.log(`Pages: ${documentContent.startPageNumber} to ${documentContent.endPageNumber}`);
    console.log();

    if (!documentContent.fields) {
      console.log("No fields found in the analysis result.");
      return;
    }

    // Extract simple string fields
    const customerNameField = documentContent.fields["CustomerName"];
    const invoiceDateField = documentContent.fields["InvoiceDate"];

    const getFieldValue = (field) => {
      if (!field) return undefined;
      if ("valueString" in field) return field.valueString;
      if ("valueDate" in field) return field.valueDate;
      if ("valueNumber" in field) return String(field.valueNumber);
      if ("valueInteger" in field) return String(field.valueInteger);
      return undefined;
    };

    const customerName = getFieldValue(customerNameField);
    const invoiceDate = getFieldValue(invoiceDateField);

    console.log(`Customer Name: ${customerName ?? "(None)"}`);
    if (customerNameField) {
      console.log(
        `  Confidence: ${customerNameField.confidence !== undefined ? customerNameField.confidence.toFixed(2) : "N/A"}`,
      );
      console.log(`  Source: ${customerNameField.source ?? "N/A"}`);
      if (customerNameField.spans && customerNameField.spans.length > 0) {
        const span = customerNameField.spans[0];
        console.log(`  Position in markdown: offset=${span.offset}, length=${span.length}`);
      }
    }

    console.log(`Invoice Date: ${invoiceDate ?? "(None)"}`);
    if (invoiceDateField) {
      console.log(
        `  Confidence: ${invoiceDateField.confidence !== undefined ? invoiceDateField.confidence.toFixed(2) : "N/A"}`,
      );
    }

    // Extract object field (TotalAmount contains Amount and CurrencyCode)
    const totalAmountField = documentContent.fields["TotalAmount"];
    if (totalAmountField && totalAmountField.type === "object") {
      const objField = totalAmountField;
      if (objField.valueObject) {
        const amountField = objField.valueObject["Amount"];
        const currencyField = objField.valueObject["CurrencyCode"];

        const amount = getFieldValue(amountField);
        const currency = getFieldValue(currencyField);

        console.log(`\nTotal Amount: ${amount} ${currency}`);
        if (totalAmountField.confidence !== undefined) {
          console.log(`  Confidence: ${totalAmountField.confidence.toFixed(2)}`);
        }
      }
    }

    // Extract array field (LineItems - line items)
    const lineItemsField = documentContent.fields["LineItems"];
    if (lineItemsField && lineItemsField.type === "array") {
      const arrField = lineItemsField;
      if (arrField.valueArray && arrField.valueArray.length > 0) {
        console.log(`\nLine Items (${arrField.valueArray.length}):`);
        arrField.valueArray.forEach((item, index) => {
          if (item.type === "object") {
            const itemObj = item;
            if (itemObj.valueObject) {
              const descriptionField = itemObj.valueObject["Description"];
              const quantityField = itemObj.valueObject["Quantity"];
              const unitPriceField = itemObj.valueObject["UnitPrice"];
              const amountField = itemObj.valueObject["Amount"];

              const description = getFieldValue(descriptionField) ?? "(no description)";
              const quantity = getFieldValue(quantityField) ?? "N/A";

              // Display price information - prefer UnitPrice if available, otherwise Amount
              let priceInfo = "";
              if (unitPriceField && unitPriceField.type === "object") {
                const unitPriceObj = unitPriceField;
                if (unitPriceObj.valueObject) {
                  const unitPriceAmount = unitPriceObj.valueObject["Amount"];
                  const unitPriceCurrency = unitPriceObj.valueObject["CurrencyCode"];
                  if (unitPriceAmount) {
                    const amt = getFieldValue(unitPriceAmount);
                    const curr = getFieldValue(unitPriceCurrency) ?? "";
                    priceInfo = `Unit Price: ${amt} ${curr}`.trim();
                  }
                }
              } else if (amountField) {
                const amt = getFieldValue(amountField);
                if (amt !== undefined) {
                  priceInfo = `Amount: ${amt}`;
                }
              }

              console.log(`  ${index + 1}. ${description}`);
              console.log(`     Quantity: ${quantity}${priceInfo ? `, ${priceInfo}` : ""}`);
            }
          }
        });
      }
    }
  }
}

main().catch((err) => {
  console.error("The sample encountered an error:", err);
});

module.exports = { main };
