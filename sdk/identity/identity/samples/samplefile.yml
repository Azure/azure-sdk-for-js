trigger:
  - main

pool:
  vmImage: ubuntu-latest

steps:
  - script: |
      npm install @azure/identity@4.3.0
      npm install @azure/keyvault-secrets
    displayName: "Install the test version of Azure Identity"

  - task: AzureCLI@2
    displayName: "Azure CLI Task"
    env:
      SYSTEM_ACCESSTOKEN: $(System.AccessToken)
    inputs:
      azureSubscription: "Azure SDK Test Resources (2cd617ea-1866-46b1-90e3-fffb087ebf9b)"
      scriptType: bash
      scriptLocation: "inlineScript"
      inlineScript: |
        node - 
        const { AzurePipelinesCredential } = await import("@azure/identity");
        const { SecretClient } = await import("@azure/keyvault-secrets");
        const {dotenv } = await import("dotenv");

        dotenv.config();
        async function main(){
            const clientId = "<your_client_id>";
            const tenantId = "<your_tenant_id>";
            const serviceConnectionId = "<your_service_connection_id>";
            const systemAccessToken = process.env.SYSTEM_ACCESSTOKEN;
            const credential = new AzurePipelinesCredential(
              tenantId,
              clientId,
              serviceConnectionId,
              systemAccessToken
            );  
          const client = new SecretClient("https://azuresdk-testsecrets2.vault.azure.net/", credential);
          const secretValue = await client.getSecret("secretKey");
          console.log("the value of secret is", secretValue);
        }
        main().catch((err) => {
          console.error("The sample encountered an error:", err);
        });
