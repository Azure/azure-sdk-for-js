trigger:
  - main

pool:
  vmImage: ubuntu-latest

steps:
  - script: |
      npm install @azure/identity@4.3.0
      npm install @azure/keyvault-secrets
    displayName: "Install the test version of Azure Identity"

  - task: AzureCLI@2
    displayName: "Azure CLI Task"
    env:
      SYSTEM_ACCESSTOKEN: $(System.AccessToken)
    inputs:
      azureSubscription: "ManagedIdentityUser"
      scriptType: bash
      scriptLocation: "inlineScript"
      inlineScript: |
        typescript -
        import { AzurePipelinesCredential } from "@azure/identity"
        import { SecretClient } from "@azure/keyvault-secrets"
        import dotenv from "dotenv";

        dotenv.config();
        function withAzurePipelinesCredential() {
            const clientId = "7960e60e-aabb-47e7-9ac5-7145dd8157a4";
            const tenantId = "72f988bf-86f1-41af-91ab-2d7cd011db47";
            const serviceConnectionId = "59b37403-61d1-4653-bcd2-0e9f58d68f32";
            const systemAccessToken = process.env.SYSTEM_ACCESSTOKEN;
            const credential = new AzurePipelinesCredential(
              tenantId,
              clientId,
              serviceConnectionId,
              systemAccessToken
            );  
          const client = new SecretClient("https://azuresdk-testsecrets2.vault.azure.net/", credential);
          const secretValue = await client.getSecret("secretKey");
          console.log("the value of secret is", secretValue);
        }
        async function main(){
          withAzurePipelinesCredential();
        }
        main().catch((err) => {
          console.error("The sample encountered an error:", err);
        });

