// Copyright (c) Microsoft Corporation.
// Licensed under the MIT license.

const { EventGridConsumer, isSystemEvent } = require("@azure/eventgrid");
const { ServiceBusClient } = require("@azure/service-bus");
const dotenv = require("dotenv");

// Load the .env file if it exists
dotenv.config();

// The connection string for Service Bus namespace that Event Grid will deliver messages to.
// You can find the connection string in the Azure portal.
// Navigate to Settings > Shared access policies > RootManageSharedAccessKey in your Service Bus Namespace's menu blade to see 
// the connection string.
const serviceBusClientConnectionString = process.env["SERVICE_BUS_CONNECTION_STRING"] || "";

// The name of the queue within the Service Bus namespace that Event Grid will deliver messages to.
const serviceBusQueueName = process.env["SERVICE_BUS_QUEUE_NAME"] || "";

// Create a receiver to read messages from the Service Bus Queue.
const receiver = new ServiceBusClient(serviceBusClientConnectionString).createReceiver(serviceBusQueueName);

// Create a Event Grid Consumer which will decode the payload of service bus message into an array of EventGridEvent objects.
const consumer = new EventGridConsumer();

// The handler function which will be run on each message we remove from the Service Bus Queue.
async function processMessage(message) {    
    // Convert the message into an array of Event Grid Events.
    const events = await consumer.deserializeEventGridEvents(message.body);

    // Process each message, printing the type and ID. In addition, if the event is a system event generated by Azure when
    // a blob is created, print the URL from the event.
    for (const event of events) {
        console.log(`Processing event of type ${event.eventType} with id: ${event.id}`);        
        if (isSystemEvent("Microsoft.Storage.BlobCreated", event)) {
            console.log(`A blob was created with URL: ${event.data.url}`);
        }
    }

    // Complete the message so that it is removed from the queue and not processed again.
    await message.complete();
}

// Start processing events.
receiver.subscribe({
    processMessage,
    processError: async (err) => {
        console.error("The sample encountered an error:", err);      
    }
});
