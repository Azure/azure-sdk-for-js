trigger: none

pr:
  branches:
    include:
      - main
  paths:
    include:
      - '**/*.bicep'
      - eng/pipelines/bicep-warnings.yml

variables:
  - template: /eng/pipelines/templates/variables/image.yml

stages:
  - stage: LintBicepFiles
    displayName: Lint Bicep Files

    pool:
      name: $(LINUXPOOL)
      vmImage: $(LINUXVMIMAGE) 

    jobs:
      - job: LintBicep
        timeoutInMinutes: 20
        steps:
          - script: |
              az bicep install
              find . -name '*.bicep' -exec az bicep lint --file {} \; > lint-warnings.txt 2>&1
            displayName: 'Install Bicep CLI and Lint Bicep Files'

          - script: |
              DATE=$(date +'%Y-%m-%d')
              sed '/^$/N;/^\n$/D;' lint-warnings.txt > lint-warnings-${DATE}.txt
              cat lint-warnings-${DATE}.txt
            displayName: 'Rename Lint Warnings File with Date'

          - task: PublishPipelineArtifact@1
            inputs:
              targetPath: 'lint-warnings-$(date +%Y-%m-%d).txt'
              artifactName: 'bicep-lint-warnings-$(date +%Y-%m-%d)'

          - task: AzureFileCopy@6
            displayName: 'Upload Bicep Lint Warnings'
            inputs:
              sourcePath: 'lint-warnings-$(date +%Y-%m-%d).txt'
              azureSubscription: 'Azure SDK Artifacts'
              destination: AzureBlob
              storage: azuresdkartifacts
              containerName: 'azure-sdk-for-js'
              blobPrefix: 'bicep-warnings/$(date +%Y-%m-%d)'
