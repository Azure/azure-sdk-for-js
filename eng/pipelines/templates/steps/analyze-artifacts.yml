parameters:
  Artifacts: []
  ServiceDirectory: not-specified
  TestPipeline: false

steps:
  # FIRST CONSUME ARTIFACTS

  - download: current
    displayName: "Download artifacts"
  
  # Some projects can have several artifacts, so we need to loop through them.
  - ${{ each artifact in parameters.Artifacts }}:

    - script: |
        tree $(Pipeline.Workspace)
      displayName: "Show tree"
    
    # THEN EXTRACT THE DOCUMENTATION ZIP FILE
    - task: ExtractFiles@1
      inputs:
        archiveFilePatterns: '$(Pipeline.Workspace)/packages/${{artifact.name}}/documentation/**/*.zip' 
        destinationFolder: '$(Pipeline.Workspace)/html-docs/'

    - script: |
        tree $(Pipeline.Workspace)/html-docs
      displayName: "Show tree"
    
    # PowerShell
    # Run a PowerShell script on Linux, macOS, or Windows
    - task: PowerShell@2
      inputs:
        targetType: 'inline' # Optional. Options: filePath, inline
        #filePath: # Required when targetType == FilePath
        #arguments: # Optional
        script: 'rm -r $(Pipeline.Workspace)/html-docs/**/assets ' # Required when targetType == Inline
        #errorActionPreference: 'stop' # Optional. Options: default, stop, continue, silentlyContinue
        #warningPreference: 'default' # Optional. Options: default, stop, continue, silentlyContinue
        #informationPreference: 'default' # Optional. Options: default, stop, continue, silentlyContinue
        #verbosePreference: 'default' # Optional. Options: default, stop, continue, silentlyContinue
        #debugPreference: 'default' # Optional. Options: default, stop, continue, silentlyContinue
        #failOnStderr: false # Optional
        #ignoreLASTEXITCODE: false # Optional
        #pwsh: false # Optional
        #workingDirectory: # Optional

    # NOW CALL VERIFY LINKS, with the artifactS url

    - template: /eng/common/pipelines/templates/steps/verify-links.yml
      parameters:
        Directory: "/html-docs/"
        WorkingDirectory: "$(Pipeline.Workspace)"
        Urls: (Get-ChildItem -Path ./ -Recurse -Include *.html)
        CheckLinkGuidance: $true

    # - template: /eng/common/pipelines/templates/steps/verify-links.yml
    #   parameters:
    #     Directory: "/html-docs/azure-search-documents/11.3.0-beta.8/classes"
    #     WorkingDirectory: "$(Build.SourcesDirectory)"
    #     Urls: (Get-ChildItem -Path ./ -Recurse -Include *.html)
    #     CheckLinkGuidance: $true
