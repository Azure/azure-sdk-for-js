parameters:
  Artifacts: []
  ServiceDirectory: not-specified
  TestProxy: true
  OSName: ''

steps:
  - template: /eng/common/pipelines/templates/steps/verify-agent-os.yml
    parameters:
      AgentImage: ${{ parameters.OSName}}

  - script: |
      node common/scripts/install-run-rush.js install
    displayName: "Install dependencies"

  - template: /eng/pipelines/templates/steps/set-artifact-packages.yml
    parameters:
      Artifacts: ${{ parameters.Artifacts }}

  # Option "-p max" ensures parallelism is set to the number of cores on all platforms, which improves build times.
  # The default on Windows is "cores - 1" (microsoft/rushstack#436).
  - script: |
      node eng/tools/rush-runner.js build "${{parameters.ServiceDirectory}}" -packages "$(ArtifactPackageNames)" --verbose -p max
    displayName: "Build libraries"

  # Option "-p max" ensures parallelism is set to the number of cores on all platforms, which improves build times.
  # The default on Windows is "cores - 1" (microsoft/rushstack#436).
  - script: |
      node eng/tools/rush-runner.js build:test "${{parameters.ServiceDirectory}}" -packages "$(ArtifactPackageNames)" --verbose -p max
    displayName: "Build test assets"

  - template: ../steps/use-node-test-version.yml

  - ${{ if eq(parameters.TestProxy, true) }}:
    - template: /eng/common/testproxy/test-proxy-tool.yml

  # As of npm v7, "npm install -g" no longer installs local dependencies as part of the global install.
  # As a workaround, we run "npm install --prod" before "npm install -g".
  # https://github.com/npm/cli/issues/2968
  - pwsh: npm install --prod; npm install -g
    workingDirectory: $(Build.SourcesDirectory)/common/tools/dev-tool
    displayName: Install dev-tool
    condition: and(succeeded(), eq(variables['TestType'], 'browser'))

  - pwsh: |
      Start-Process "dev-tool" -ArgumentList "run start-browser-relay" -NoNewWindow
      for ($i = 0; $i -lt 10; $i++) {
          try {
              Invoke-WebRequest -Uri "http://localhost:4895/health" | Out-Null
              exit 0
          } catch {
              Write-Warning "Failed to successfully connect to browser credential relay. Retrying..."
              Start-Sleep 6
          }
      }
      Write-Error "Could not connect to browser credential relay."
      exit 1
    displayName: "Start browser credential relay"
    condition: and(succeeded(), eq(variables['TestType'], 'browser'))
  
  # Option "-p max" ensures parallelism is set to the number of cores on all platforms, which improves build times.
  # The default on Windows is "cores - 1" (microsoft/rushstack#436).
  - script: |
      node eng/tools/rush-runner.js unit-test:node "${{parameters.ServiceDirectory}}" -packages "$(ArtifactPackageNames)" --verbose -p max
    displayName: "Test libraries"
    condition: and(succeeded(),eq(variables['TestType'], 'node'))

  # Option "-p max" ensures parallelism is set to the number of cores on all platforms, which improves build times.
  # The default on Windows is "cores - 1" (microsoft/rushstack#436).
  - script: |
      node eng/tools/rush-runner.js unit-test:browser "${{parameters.ServiceDirectory}}" -packages "$(ArtifactPackageNames)" --verbose -p max
    displayName: "Test libraries"
    condition: and(succeeded(),eq(variables['TestType'], 'browser'))

  - ${{ if eq(parameters.TestProxy, true) }}:
    - pwsh: |
        cat $(Build.SourcesDirectory)/test-proxy.log
      displayName: 'Dump Test Proxy logs'
      condition: succeededOrFailed()
      
  # Unlink node_modules folders to significantly improve performance of subsequent tasks
  # which need to walk the directory tree (and are hardcoded to follow symlinks).
  # Retry for 30 seconds, since this command may fail with error "Another rush command is already
  # running in this repository" if the previous rush command was killed.
  - pwsh: |
      for ($i=0; $i -lt 30; $i++) {
        node eng/tools/rush-runner.js unlink
        if ($lastexitcode -eq 0) {
          break
        }
        else {
          start-sleep 1
        }
      }
    condition: always()
    displayName: "Unlink dependencies"

  # It's important for performance to pass "sdk" as "searchFolder" to avoid looking under root "node_modules".
  # PublishTestResults.searchFolder only supports absolute paths, not relative.
  - task: PublishTestResults@2
    inputs:
      searchFolder: "$(System.DefaultWorkingDirectory)/sdk"
      testResultsFiles: "**/test-results.xml"
      testRunTitle: "$(OSName) - NodeJS - Unit Tests - [Node $(NodeTestVersion)]"
    condition: and(always(),eq(variables['TestType'], 'node'))
    displayName: "Publish NodeJS unit test results"

  # It's important for performance to pass "sdk" as "searchFolder" to avoid looking under root "node_modules".
  # PublishTestResults.searchFolder only supports absolute paths, not relative.
  - task: PublishTestResults@2
    inputs:
      searchFolder: "$(System.DefaultWorkingDirectory)/sdk"
      testResultsFiles: "**/test-results.browser.xml"
      testRunTitle: "$(OSName) - Browser - Unit Tests - [Node $(NodeTestVersion)]"
    condition: and(always(),eq(variables['TestType'], 'browser'))
    displayName: "Publish browser unit test results"
