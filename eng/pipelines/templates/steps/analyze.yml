parameters:
  Artifacts: []
  ServiceDirectory: not-specified
  TestPipeline: false

steps:
  - template: /eng/common/pipelines/templates/steps/save-package-properties.yml
    parameters:
      ServiceDirectory: ${{parameters.ServiceDirectory}}

  - template: /eng/pipelines/templates/steps/set-artifact-packages.yml
    parameters:
      PackageInfo: $(Build.ArtifactStagingDirectory)/PackageInfo
      Artifacts: ${{ parameters.Artifacts }}

  - template: /eng/common/pipelines/templates/steps/check-spelling.yml
    parameters:
      ScriptToValidateUpgrade: eng/scripts/spell-check-public-api.ps1

  - task: PowerShell@2
    inputs:
      targetType: 'filePath'
      filePath: eng/scripts/spell-check-public-apis.ps1
      arguments: -ChangedServices "$(ChangedServices)"
      pwsh: true
    displayName: Spell check public API

  - task: UsePythonVersion@0
    displayName: 'Use Python 3.11'
    inputs:
      versionSpec: '3.11'

  - template: /eng/common/pipelines/templates/steps/verify-readmes.yml
    parameters:
      PackagePropertiesFolder: $(Build.ArtifactStagingDirectory)/PackageInfo

  - template: /eng/common/pipelines/templates/steps/verify-path-length.yml
    parameters:
      SourceDirectory: $(Build.SourcesDirectory)

  - template: /eng/common/pipelines/templates/steps/verify-links.yml
    parameters:
      ${{ if eq(variables['Build.Reason'], 'PullRequest') }}:
        Directory: ""
        Urls: (eng/common/scripts/get-markdown-files-from-changed-files.ps1)
      ${{ if ne(variables['Build.Reason'], 'PullRequest') }}:
        Directory: sdk/${{ parameters.ServiceDirectory }}
      CheckLinkGuidance: $true

  - template: /eng/common/pipelines/templates/steps/verify-samples.yml
    parameters:
      ServiceDirectories: $(ChangedServicesCsv)

  - script: |
      npm ci
    workingDirectory: $(System.DefaultWorkingDirectory)/eng/tools/eng-package-utils
    displayName: "Install eng-package-utils dependencies"

  - script: |
      npm ci
    workingDirectory: $(System.DefaultWorkingDirectory)/eng/tools/analyze-deps
    displayName: "Install tool dependencies"

  - script: |
      node index.js --verbose --dump "$(Build.ArtifactStagingDirectory)" --out "$(Build.ArtifactStagingDirectory)/dependencies.html"
    workingDirectory: $(System.DefaultWorkingDirectory)/eng/tools/analyze-deps
    displayName: "Analyze library dependencies"

  - script: |
      npm install -g pnpm
    displayName: "Install Pnpm"

  - script: |
      pnpm install
    displayName: "Install library dependencies"

  - pwsh: |
      pnpm build --filter @azure/eslint-plugin-azure-sdk...
      $env:FORCE_COLOR = "1"
      node eng/tools/ci-runner/index.js lint "$(ChangedServices)"
    displayName: "Build ESLint Plugin and Lint Libraries"

  - pwsh: |
      node eng/tools/ci-runner/index.js check-format $(ChangedServices) -packages "$(ArtifactPackageNames)"
    displayName: "Check Format in Libraries"

  - pwsh: |
      node eng/tools/ci-runner/index.js update-snippets $(ChangedServices) -packages "$(ArtifactPackageNames)"
    displayName: "Update snippets"

  - pwsh: |
      eng/tools/check-snippet-changes.ps1
    displayName: "Check snippet changes"

  - template: /eng/common/pipelines/templates/steps/verify-changelogs.yml
    parameters:
      PackagePropertiesFolder: $(Build.ArtifactStagingDirectory)/PackageInfo

  - template: /eng/common/pipelines/templates/steps/eng-common-workflow-enforcer.yml
