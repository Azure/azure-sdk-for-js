pr:
  branches:
    include:
    - master
    - '*-preview'
  paths:
  - template: mgmt-paths.yml

variables:
  NodeVersion: 10.x
jobs:
- job: Build
  displayName: Build auto-generated projects
  pool:
    vmImage: Ubuntu 16.04
  steps:
  - task: NodeTool@0
    inputs:
      versionSpec: $(NodeVersion)
    displayName: Install Node.js $(NodeVersion)
  - task: Npm@1
    displayName: npm install
    inputs:
      command: install
  - task: Npm@1
    displayName: npm run build
    inputs:
      command: custom
      customCommand: run build -- --head-reference=origin/$(System.PullRequest.SourceBranch) --base-reference=origin/$(System.PullRequest.TargetBranch) --logging-level=trace
- job: Check_everything
  displayName: Check .only, .skip and version bump
  steps:
  - task: NodeTool@0
    inputs:
      versionSpec: $(NodeVersion)
    displayName: Install Node.js $(NodeVersion)
  - task: Npm@1
    displayName: npm install
    inputs:
      command: install
  - task: Npm@1
    displayName: npm audit
    condition: and(succeeded(), eq(variables['RunNpmAudit'], 'true'))
    inputs:
      command: custom
      customCommand: audit
  - task: Npm@1
    displayName: npm run check:everything
    inputs:
      command: custom
      customCommand: run check:everything -- --head-reference=origin/$(System.PullRequest.SourceBranch) --base-reference=origin/$(System.PullRequest.TargetBranch) --azure-devops --verbose
