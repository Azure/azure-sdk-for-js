trigger: none
pr: none

jobs:
- job: 'PnpmUpdate'
  displayName: 'pnpm update full'
  variables:
  - template: /eng/pipelines/templates/variables/globals.yml

  pool:
    name: azsdk-pool-mms-ubuntu-2004-general
    vmImage: MMSUbuntu20.04

  steps:
  - template: /eng/pipelines/templates/steps/common.yml
  - template: /eng/common/pipelines/templates/steps/set-default-branch.yml

  - script: |
      npm install -g pnpm
      pnpm up --latest
    displayName: "Run pnpm Update"

  - template: /eng/common/pipelines/templates/steps/create-pull-request.yml
    parameters:
      RepoName: azure-sdk-for-js
      BaseBranchName: $(DefaultBranch)
      PRBranchName: automated-pnpm-update-full
      CommitMsg: "Automatic pnpm up --latest"
      PRTitle: "[EngSys] automatic pnpm up --latest"
      PRBody: "This is an automatic PR generated weekly with changes from running the command pnpm up --latest"
      PushArgs: "-f"


- job: 'CheckDependency'
  displayName: 'Check Package Dependency'
  variables:
  - template: /eng/pipelines/templates/variables/globals.yml

  pool:
    name: azsdk-pool-mms-ubuntu-2004-general
    vmImage: MMSUbuntu20.04

  steps:
  - template: /eng/pipelines/templates/steps/common.yml
  - template: /eng/common/pipelines/templates/steps/set-default-branch.yml

  - script: |
      npm install -g pnpm
      pnpm unlink
      git clean -xdf
    displayName: "pnpm Unlink"

  - task: PowerShell@2
    displayName: 'Check Dependency Warnings and File GitHub Issues'
    inputs:
      targetType: filePath
      filePath: $(Build.SourcesDirectory)/eng/scripts/check-external-dependency.ps1
      arguments: >
        -RepoName azure-sdk-for-js
        -RepoOwner azure
        -AuthToken "$(azuresdk-github-pat)"
      pwsh: true

  - script: |
      git reset --hard
    displayName: "Reset Changes"
