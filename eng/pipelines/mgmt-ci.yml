trigger:
  branches:
    include:
      - master
  paths:
    include:
    - eng/pipelines/mgmt-pr.yml
    - sdk/advisor/arm-advisor
    - sdk/analysisservices/arm-analysisservices
    - sdk/apimanagement/arm-apimanagement
    - sdk/appconfiguration/arm-appconfiguration
    - sdk/applicationinsights/arm-appinsights
    - sdk/appplatform/arm-appplatform
    - sdk/appservice/arm-appservice
    - sdk/appservice/arm-appservice-profile-2019-03-01-hybrid
    - sdk/appservice/arm-appservice-profile-2020-09-01-hybrid
    - sdk/attestation/arm-attestation
    - sdk/authorization/arm-authorization
    - sdk/authorization/arm-authorization-profile-2019-03-01-hybrid
    - sdk/authorization/arm-authorization-profile-2020-09-01-hybrid
    - sdk/automation/arm-automation
    - sdk/avs/arm-avs
    - sdk/azurestack/arm-azurestack
    - sdk/azurestackhci/arm-azurestackhci
    - sdk/batch/arm-batch
    - sdk/batchai/arm-batchai
    - sdk/billing/arm-billing
    - sdk/botservice/arm-botservice
    - sdk/cdn/arm-cdn
    - sdk/changeanalysis/arm-changeanalysis
    - sdk/cognitiveservices/arm-cognitiveservices
    - sdk/commerce/arm-commerce
    - sdk/commerce/arm-commerce-profile-2020-09-01-hybrid
    - sdk/communication/arm-communication
    - sdk/compute/arm-compute
    - sdk/compute/arm-compute-profile-2019-03-01-hybrid
    - sdk/compute/arm-compute-profile-2020-09-01-hybrid
    - sdk/confluent/arm-confluent
    - sdk/consumption/arm-consumption
    - sdk/containerinstance/arm-containerinstance
    - sdk/containerregistry/arm-containerregistry
    - sdk/containerservice/arm-containerservice
    - sdk/cosmosdb/arm-cosmosdb
    - sdk/customer-insights/arm-customerinsights
    - sdk/databox/arm-databox
    - sdk/databoxedge/arm-databoxedge
    - sdk/databoxedge/arm-databoxedge-profile-2020-09-01-hybrid
    - sdk/databricks/arm-databricks
    - sdk/datacatalog/arm-datacatalog
    - sdk/datafactory/arm-datafactory
    - sdk/datalake-analytics/arm-datalake-analytics
    - sdk/datamigration/arm-datamigration
    - sdk/deploymentmanager/arm-deploymentmanager
    - sdk/deviceprovisioningservices/arm-deviceprovisioningservices
    - sdk/devspaces/arm-devspaces
    - sdk/devtestlabs/arm-devtestlabs
    - sdk/digitaltwins/arm-digitaltwins
    - sdk/dns/arm-dns
    - sdk/dns/arm-dns-profile-2019-03-01-hybrid
    - sdk/dns/arm-dns-profile-2020-09-01-hybrid
    - sdk/domainservices/arm-domainservices
    - sdk/edgegateway/arm-edgegateway
    - sdk/eventgrid/arm-eventgrid
    - sdk/eventhub/arm-eventhub
    - sdk/eventhub/arm-eventhub-profile-2020-09-01-hybrid
    - sdk/features/arm-features
    - sdk/frontdoor/arm-frontdoor
    - sdk/hanaonazure/arm-hanaonazure
    - sdk/hdinsight/arm-hdinsight
    - sdk/healthbot/arm-healthbot
    - sdk/healthcareapis/arm-healthcareapis
    - sdk/hybridcompute/arm-hybridcompute
    - sdk/hybridkubernetes/arm-hybridkubernetes
    - sdk/iotcentral/arm-iotcentral
    - sdk/iothub/arm-iothub
    - sdk/iothub/arm-iothub-profile-2020-09-01-hybrid
    - sdk/iotspaces/arm-iotspaces
    - sdk/keyvault/arm-keyvault
    - sdk/keyvault/arm-keyvault-profile-2019-03-01-hybrid
    - sdk/keyvault/arm-keyvault-profile-2020-09-01-hybrid
    - sdk/kubernetesconfiguration/arm-kubernetesconfiguration
    - sdk/kusto/arm-kusto
    - sdk/labservices/arm-labservices
    - sdk/links/arm-links
    - sdk/locks/arm-locks
    - sdk/locks/arm-locks-profile-2020-09-01-hybrid
    - sdk/locks/arm-locks-profile-hybrid-2019-03-01
    - sdk/logic/arm-logic
    - sdk/machinelearning/arm-commitmentplans
    - sdk/machinelearning/arm-webservices
    - sdk/machinelearning/arm-workspaces
    - sdk/machinelearningcompute/arm-machinelearningcompute
    - sdk/machinelearningexperimentation/arm-machinelearningexperimentation
    - sdk/machinelearningservices/arm-machinelearningservices
    - sdk/managedapplications/arm-managedapplications
    - sdk/managementgroups/arm-managementgroups
    - sdk/managementpartner/arm-managementpartner
    - sdk/maps/arm-maps
    - sdk/mariadb/arm-mariadb
    - sdk/marketplaceordering/arm-marketplaceordering
    - sdk/mediaservices/arm-mediaservices
    - sdk/migrate/arm-migrate
    - sdk/mixedreality/arm-mixedreality
    - sdk/monitor/arm-monitor
    - sdk/monitor/arm-monitor-profile-2019-03-01-hybrid
    - sdk/monitor/arm-monitor-profile-2020-09-01-hybrid
    - sdk/msi/arm-msi
    - sdk/mysql/arm-mysql
    - sdk/netapp/arm-netapp
    - sdk/network/arm-network
    - sdk/network/arm-network-profile-2019-03-01-hybrid
    - sdk/network/arm-network-profile-2020-09-01-hybrid
    - sdk/notificationhubs/arm-notificationhubs
    - sdk/operationalinsights/arm-operationalinsights
    - sdk/operationsmanagement/arm-operations
    - sdk/peering/arm-peering
    - sdk/policy/arm-policy
    - sdk/policy/arm-policy-profile-2020-09-01-hybrid
    - sdk/policy/arm-policy-profile-hybrid-2019-03-01
    - sdk/policyinsights/arm-policyinsights
    - sdk/postgresql/arm-postgresql
    - sdk/powerbidedicated/arm-powerbidedicated
    - sdk/powerbiembedded/arm-powerbiembedded
    - sdk/privatedns/arm-privatedns
    - sdk/recoveryservices/arm-recoveryservices
    - sdk/recoveryservicesbackup/arm-recoveryservicesbackup
    - sdk/recoveryservicessiterecovery/arm-recoveryservices-siterecovery
    - sdk/redis/arm-rediscache
    - sdk/redisenterprise/arm-redisenterprisecache
    - sdk/relay/arm-relay
    - sdk/reservations/arm-reservations
    - sdk/resourcegraph/arm-resourcegraph
    - sdk/resourcehealth/arm-resourcehealth
    - sdk/resourcemover/arm-resourcemover
    - sdk/resources/arm-resources
    - sdk/resources/arm-resources-profile-2020-09-01-hybrid
    - sdk/resources/arm-resources-profile-hybrid-2019-03-01
    - sdk/search/arm-search
    - sdk/security/arm-security
    - sdk/serialconsole/arm-serialconsole
    - sdk/service-map/arm-servicemap
    - sdk/servicebus/arm-servicebus
    - sdk/servicefabric/arm-servicefabric
    - sdk/servicefabricmesh/arm-servicefabricmesh
    - sdk/signalr/arm-signalr
    - sdk/sql/arm-sql
    - sdk/sqlvirtualmachine/arm-sqlvirtualmachine
    - sdk/storage/arm-storage
    - sdk/storage/arm-storage-profile-2019-03-01-hybrid
    - sdk/storage/arm-storage-profile-2020-09-01-hybrid
    - sdk/storagecache/arm-storagecache
    - sdk/storageimportexport/arm-storageimportexport
    - sdk/storagesync/arm-storagesync
    - sdk/storsimple1200series/arm-storsimple1200series
    - sdk/storsimple8000series/arm-storsimple8000series
    - sdk/streamanalytics/arm-streamanalytics
    - sdk/subscription/arm-subscriptions
    - sdk/subscription/arm-subscriptions-profile-2020-09-01-hybrid
    - sdk/subscription/arm-subscriptions-profile-hybrid-2019-03-01
    - sdk/support/arm-support
    - sdk/synapse/arm-synapse
    - sdk/timeseriesinsights/arm-timeseriesinsights
    - sdk/trafficmanager/arm-trafficmanager
    - sdk/visualstudio/arm-visualstudio
    - sdk/vmwarecloudsimple/arm-vmwarecloudsimple
    - sdk/applicationinsights/applicationinsights-query
    - sdk/batch/batch
    - sdk/cognitiveservices/cognitiveservices-anomalydetector
    - sdk/cognitiveservices/cognitiveservices-autosuggest
    - sdk/cognitiveservices/cognitiveservices-computervision
    - sdk/cognitiveservices/cognitiveservices-contentmoderator
    - sdk/cognitiveservices/cognitiveservices-customimagesearch
    - sdk/cognitiveservices/cognitiveservices-customsearch
    - sdk/cognitiveservices/cognitiveservices-customvision-prediction
    - sdk/cognitiveservices/cognitiveservices-customvision-training
    - sdk/cognitiveservices/cognitiveservices-entitysearch
    - sdk/cognitiveservices/cognitiveservices-face
    - sdk/cognitiveservices/cognitiveservices-formrecognizer
    - sdk/cognitiveservices/cognitiveservices-imagesearch
    - sdk/cognitiveservices/cognitiveservices-localsearch
    - sdk/cognitiveservices/cognitiveservices-luis-authoring
    - sdk/cognitiveservices/cognitiveservices-luis-runtime
    - sdk/cognitiveservices/cognitiveservices-newssearch
    - sdk/cognitiveservices/cognitiveservices-personalizer
    - sdk/cognitiveservices/cognitiveservices-qnamaker
    - sdk/cognitiveservices/cognitiveservices-qnamaker-runtime
    - sdk/cognitiveservices/cognitiveservices-spellcheck
    - sdk/cognitiveservices/cognitiveservices-textanalytics
    - sdk/cognitiveservices/cognitiveservices-translatortext
    - sdk/cognitiveservices/cognitiveservices-videosearch
    - sdk/cognitiveservices/cognitiveservices-visualsearch
    - sdk/cognitiveservices/cognitiveservices-websearch
    - sdk/eventhub/event-processor-host
    - sdk/graphrbac/graph
    - sdk/keyvault/keyvault-common
    - sdk/operationalinsights/loganalytics
    - sdk/servicefabric/servicefabric
    - sdk/storage/storage-datalake
    - sdk/storage/storage-internal-avro

pr: none

variables:
  NodeVersion: '10.x'

jobs:
  - job: 'Build'

    pool:
      vmImage: 'Ubuntu 16.04'

    steps:
      - task: NodeTool@0
        inputs:
          versionSpec: '$(NodeVersion)'
        displayName: 'Install Node.js $(NodeVersion)'

      - task: Npm@1
        displayName: 'npm install'
        inputs:
          verbose: false

      - script: 'gulp pack --base-reference=master --head-reference=master'
        displayName: 'gulp pack'

      - task: CopyFiles@2
        displayName: 'Copy Files to: drop'
        inputs:
          Contents: '*.tgz'
          TargetFolder: drop

      - task: PublishBuildArtifacts@1
        inputs:
          pathtoPublish: $(Build.SourcesDirectory)/drop

  - job: 'Analyze'

    pool:
      vmImage: 'Ubuntu 16.04'

    steps:
      - task: NodeTool@0
        inputs:
          versionSpec: '$(NodeVersion)'
        displayName: 'Install Node.js $(NodeVersion)'

      - task: Npm@1
        displayName: 'npm install'
        inputs:
          command: install

      - task: Npm@1
        displayName: 'npm audit'
        condition: and(succeeded(), eq(variables['RunNpmAudit'], 'true'))
        inputs:
          command: custom
          customCommand: 'audit'
